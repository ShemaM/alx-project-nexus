# BYN-K Platform - Production Deployment Guide

This guide covers deploying the BYN-K Platform with:
- **Frontend**: Next.js on Vercel
- **Backend**: Django on Render
- **Database**: PostgreSQL on Render

## Architecture Overview

```
┌─────────────────────────────────────┐       ┌───────────────────────────────────┐
│        Vercel (Frontend)            │──────▶│        Render (Backend)           │
│        Next.js App                  │ HTTPS │        Django API                 │
│  opportunities-for-banyamulenge-    │◀──────│  alx-project-nexus-53hq.          │
│        yout.vercel.app              │       │        onrender.com               │
└─────────────────────────────────────┘       └───────────────────────────────────┘
                                                              │
                                                              ▼
                                              ┌───────────────────────────────────┐
                                              │       Render PostgreSQL           │
                                              │           nexus-db                │
                                              └───────────────────────────────────┘
```

## Required Environment Variables

### Vercel (Frontend) Environment Variables

Set these in your Vercel project settings → Environment Variables:

| Variable | Required | Description | Example |
|----------|----------|-------------|---------|
| `NEXT_PUBLIC_API_URL` | ✅ | Render backend API URL | `https://alx-project-nexus-53hq.onrender.com/api` |
| `NEXTAUTH_URL` | ✅ | Vercel deployment URL | `https://opportunities-for-banyamulenge-yout.vercel.app` |
| `NEXTAUTH_SECRET` | ✅ | Auth secret (32+ chars) | `openssl rand -base64 32` |
| `GOOGLE_CLIENT_ID` | Optional | Google OAuth client ID | `xxx.apps.googleusercontent.com` |
| `GOOGLE_CLIENT_SECRET` | Optional | Google OAuth secret | `GOCSPX-xxx` |
| `LINKEDIN_CLIENT_ID` | Optional | LinkedIn OAuth client ID | `xxx` |
| `LINKEDIN_CLIENT_SECRET` | Optional | LinkedIn OAuth secret | `xxx` |

### Render (Backend) Environment Variables

Set these in your Render service dashboard → Environment:

| Variable | Required | Description | Example |
|----------|----------|-------------|---------|
| `DATABASE_URL` | ✅ | Auto-set by Render PostgreSQL | `postgres://...` |
| `DJANGO_SECRET_KEY` | ✅ | Auto-generated by Render | (auto) |
| `DEBUG` | ✅ | Must be "false" in production | `false` |
| `ALLOWED_HOSTS` | ✅ | Comma-separated hostnames | `localhost,127.0.0.1,.onrender.com,.vercel.app` |
| `FRONTEND_URL` | ✅ | Vercel frontend URL | `https://opportunities-for-banyamulenge-yout.vercel.app` |
| `BACKEND_PUBLIC_URL` | ✅ | Render backend URL | `https://alx-project-nexus-53hq.onrender.com` |
| `DJANGO_SUPERUSER_USERNAME` | ✅ | Admin username | `admin` |
| `DJANGO_SUPERUSER_PASSWORD` | ✅ | Admin password (strong!) | `SecureP@ss123!` |
| `DJANGO_SUPERUSER_EMAIL` | ✅ | Admin email | `admin@example.com` |
| `PLATFORM_SUPERADMIN_USERNAME` | Optional | Same as DJANGO_SUPERUSER | `admin` |
| `PLATFORM_SUPERADMIN_EMAIL` | Optional | Same as DJANGO_SUPERUSER | `admin@example.com` |
| `PLATFORM_SUPERADMIN_PASSWORD` | Optional | Same as DJANGO_SUPERUSER | `SecureP@ss123!` |
| `GOOGLE_CLIENT_ID` | Optional | Google OAuth | `xxx.apps.googleusercontent.com` |
| `GOOGLE_CLIENT_SECRET` | Optional | Google OAuth | `GOCSPX-xxx` |
| `GOOGLE_REDIRECT_URI` | Optional | Google OAuth callback | `https://opportunities-for-banyamulenge-yout.vercel.app/api/auth/callback/google` |

## Step-by-Step Deployment

### 1. Deploy Backend to Render

1. **Connect Repository**: Connect your GitHub repo to Render
2. **Create PostgreSQL Database**:
   - Dashboard → New → PostgreSQL
   - Name: `nexus-db`
   - This auto-creates the `DATABASE_URL`

3. **Create Web Service**:
   - Dashboard → New → Web Service
   - Select your repository
   - Root Directory: `backend`
   - Build Command: `./build.sh`
   - Start Command: `python init_prod.py && gunicorn config.wsgi:application`

4. **Set Environment Variables** (as listed above)

5. **Deploy**: Render will auto-deploy on every push

### 2. Deploy Frontend to Vercel

1. **Import Project**: Import your GitHub repo to Vercel
2. **Set Root Directory**: `byn-k-platform`
3. **Set Environment Variables** (as listed above)
4. **Deploy**: Vercel auto-deploys on every push

### 3. Verify Connectivity

Test the connection between frontend and backend:

```bash
# Test backend health
curl https://your-backend.onrender.com/health/

# Test API endpoint
curl https://your-backend.onrender.com/api/opportunities/

# Test from Vercel (via browser console or API route)
fetch('https://your-frontend.vercel.app/api/proxy/health/')
  .then(r => r.json())
  .then(console.log)
```

## Admin Panel Access

The Django admin panel is accessible at:
```
https://your-backend.onrender.com/admin/
```

**Important**: Only superusers can access the admin panel. The credentials are set via environment variables:
- `DJANGO_SUPERUSER_USERNAME`
- `DJANGO_SUPERUSER_PASSWORD`

### Troubleshooting Admin Access

1. **403 Forbidden**: Ensure `ALLOWED_HOSTS` includes `.onrender.com`
2. **CSRF Failed**: Ensure `CSRF_TRUSTED_ORIGINS` includes your frontend URL
3. **Session Issues**: Check that `SESSION_COOKIE_SECURE=True` for HTTPS

## CORS Configuration

The backend automatically configures CORS based on environment variables:

- `FRONTEND_URL` is added to `CORS_ALLOWED_ORIGINS`
- `localhost:3000` is included for development
- `CORS_ALLOW_CREDENTIALS = True` for cookie-based auth

## Common Issues

### 1. "Network Error" on Frontend

**Symptoms**: API calls fail with network errors

**Solutions**:
- Verify `NEXT_PUBLIC_API_URL` is correctly set in Vercel
- Check Render logs for errors
- Test the health endpoint directly

### 2. "CORS Policy Blocked"

**Symptoms**: Browser console shows CORS errors

**Solutions**:
- Ensure `FRONTEND_URL` in Render matches your Vercel URL exactly
- Check that no trailing slash exists in the URL
- Verify `corsheaders` middleware is first in Django

### 3. "Admin Login Redirect Loop"

**Symptoms**: Admin login redirects back to login

**Solutions**:
- Clear browser cookies
- Ensure superuser credentials are correct
- Check session cookie settings

### 4. "502 Bad Gateway"

**Symptoms**: Requests return 502 errors

**Solutions**:
- Check Render logs for application errors
- Verify Gunicorn is starting correctly
- Ensure all migrations have run

## Security Checklist

- [ ] `DEBUG=false` in production
- [ ] Strong `DJANGO_SECRET_KEY` (auto-generated)
- [ ] Strong admin password (12+ chars, mixed case, numbers, symbols)
- [ ] HTTPS enabled on both Vercel and Render
- [ ] `SECURE_SSL_REDIRECT=True` in Django
- [ ] OAuth secrets are not exposed in code

## Monitoring

### Health Check Endpoint

The backend provides a health check endpoint at `/health/` that returns:

```json
{
  "status": "healthy",
  "service": "byn-k-backend",
  "database": "ok",
  "debug_mode": false,
  "cors_config": {
    "request_origin": "https://byn-k.vercel.app",
    "allowed_origins": ["https://byn-k.vercel.app"],
    "credentials_allowed": true
  },
  "environment": {
    "frontend_url": "https://byn-k.vercel.app",
    "backend_url": "https://nexus-backend.onrender.com",
    "allowed_hosts": ["localhost", "127.0.0.1", ".onrender.com", ".vercel.app"]
  }
}
```

Use this endpoint to verify:
- Database connectivity
- CORS configuration
- Environment variable setup
